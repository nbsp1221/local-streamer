# HLS + μ΄μ¤‘ μ•”νΈν™” κµ¬ν„ κ³„ν

## π“‹ ν”„λ΅μ νΈ κ°μ”
PRD μ”κµ¬μ‚¬ν•­(UUID νμΌ κ΄€λ¦¬, XOR μ•”νΈν™”, νμΌ λ³΄νΈ)μ„ λ§μ΅±ν•λ©΄μ„ HLSμ μ„±λ¥ μ΄μ (λΉ λ¥Έ μ‹ν¬, μ μ‘ν• ν’μ§)μ„ ν™•λ³΄ν•λ” ν•μ΄λΈλ¦¬λ“ μ¤νΈλ¦¬λ° μ‹μ¤ν… κµ¬ν„

## π― ν•µμ‹¬ λ©ν‘
- β… μ‹ν¬ μ‹ λ²„νΌλ§ μ§€μ—° ν•΄κ²° (2μ΄ μ„Έκ·Έλ¨ΌνΈ)
- β… Netflix/YouTube μμ¤€ μ¤νΈλ¦¬λ° μ„±λ¥
- β… PRD λ³΄μ• μ”κµ¬μ‚¬ν•­ 100% λ§μ΅±
- β… κΈ°μ΅΄ React Router μ•„ν‚¤ν…μ² μ μ§€

## π—οΈ μ‹μ¤ν… μ•„ν‚¤ν…μ²

### νμΌ κµ¬μ΅°
```
data/
β”β”€β”€ pending/                    # μ¤€λΉ„ ν΄λ” (κΈ°μ΅΄ μ μ§€)
β”‚   β”β”€β”€ original_video.mp4
β”‚   β””β”€β”€ another_clip.mkv
β”β”€β”€ library/                    # λΌμ΄λΈλ¬λ¦¬ ν΄λ” (HLS λ³€ν™)
β”‚   β””β”€β”€ [uuid]/                 # UUID κΈ°λ° ν΄λ”
β”‚       β”β”€β”€ master.m3u8         # λ§μ¤ν„° ν”λ μ΄λ¦¬μ¤νΈ
β”‚       β”β”€β”€ 720p/
β”‚       β”‚   β”β”€β”€ playlist.m3u8   # 720p ν”λ μ΄λ¦¬μ¤νΈ
β”‚       β”‚   β”β”€β”€ segment_000.ts.enc  # μ΄μ¤‘μ•”νΈν™” μ„Έκ·Έλ¨ΌνΈ
β”‚       β”‚   β”β”€β”€ segment_001.ts.enc
β”‚       β”‚   β””β”€β”€ ...
β”‚       β”β”€β”€ 1080p/
β”‚       β”‚   β”β”€β”€ playlist.m3u8
β”‚       β”‚   β””β”€β”€ segment_xxx.ts.enc
β”‚       β””β”€β”€ metadata.json       # λΉ„λ””μ¤ λ©”νƒ€λ°μ΄ν„°
β”β”€β”€ keys/                       # μ•”νΈν™” ν‚¤ κ΄€λ¦¬
β”‚   β””β”€β”€ [uuid].key             # UUIDλ³„ μ•”νΈν™” ν‚¤
β””β”€β”€ videos.json                 # κΈ°μ΅΄ λ©”νƒ€λ°μ΄ν„° (HLS μ •λ³΄ μ¶”κ°€)
```

### λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§ λ³€κ²½
```json
// videos.json ν™•μ¥
{
  "id": "uuid-example",
  "title": "λΉ„λ””μ¤ μ λ©",
  "tags": ["νƒκ·Έ1", "νƒκ·Έ2"],
  "thumbnailUrl": "...",
  "videoUrl": "/data/library/uuid-example/master.m3u8",  // HLS λ§μ¤ν„° ν”λ μ΄λ¦¬μ¤νΈ
  "duration": 3600,
  "addedAt": "2025-08-01T12:00:00.000Z",
  "description": "μ„¤λ…",
  "hlsInfo": {
    "hasHLS": true,
    "qualities": ["720p", "1080p"],
    "segmentCount": 180,
    "encryptionKey": "xor-key-reference"
  }
}
```

## π”§ κµ¬ν„ λ‹¨κ³„

### 1λ‹¨κ³„: FFmpeg ν†µν•© λ° HLS λ³€ν™
**λ©ν‘**: μ—…λ΅λ“λ λΉ„λ””μ¤λ¥Ό HLS + AES-128 μ•”νΈν™”λ΅ λ³€ν™

#### ν•„μ” μμ΅΄μ„±
```bash
bun add fluent-ffmpeg @types/fluent-ffmpeg
# FFmpeg λ°”μ΄λ„λ¦¬λ” μ‹μ¤ν…μ— λ³„λ„ μ„¤μΉ ν•„μ”
```

#### κµ¬ν„ νμΌ
- `app/services/hls-converter.server.ts`: FFmpeg κΈ°λ° HLS λ³€ν™
- `app/services/encryption.server.ts`: XOR μ•”νΈν™”/λ³µνΈν™”

#### FFmpeg λ³€ν™ λ΅μ§
```typescript
// hls-converter.server.ts κµ¬μ΅°
export async function convertToHLS(inputPath: string, outputDir: string, uuid: string) {
  // 1. UUID κΈ°λ° μ¶λ ¥ λ””λ ‰ν† λ¦¬ μƒμ„±
  // 2. μ•”νΈν™” ν‚¤ μƒμ„± λ° μ €μ¥
  // 3. FFmpeg λ…λ Ήμ–΄ μ‹¤ν–‰ (AES-128 μ•”νΈν™” ν¬ν•¨)
  // 4. μƒμ„±λ .ts νμΌλ“¤μ— XOR μ¶”κ°€ μ•”νΈν™” μ μ©
  // 5. λ©”νƒ€λ°μ΄ν„° μ—…λ°μ΄νΈ
}
```

### 2λ‹¨κ³„: React Router API λΌμ°νΈ κµ¬ν„
**λ©ν‘**: HLS μ¤νΈλ¦¬λ°μ„ μ„ν• API μ—”λ“ν¬μΈνΈ κµ¬ν„

#### API λΌμ°νΈ κµ¬μ΅°
```
app/routes/
β”β”€β”€ api.hls.$uuid.ts           # λ§μ¤ν„° ν”λ μ΄λ¦¬μ¤νΈ μ κ³µ
β”β”€β”€ api.hls.$uuid.$quality.ts  # ν’μ§λ³„ ν”λ μ΄λ¦¬μ¤νΈ μ κ³µ  
β”β”€β”€ api.segment.$uuid.$file.ts # μ•”νΈν™”λ μ„Έκ·Έλ¨ΌνΈ μ κ³µ
β””β”€β”€ api.key.$uuid.ts           # HLS λ³µνΈν™” ν‚¤ μ κ³µ
```

#### κ° λΌμ°νΈ μ—­ν• 
1. **λ§μ¤ν„° ν”λ μ΄λ¦¬μ¤νΈ** (`/api/hls/uuid123`):
   - μ‚¬μ© κ°€λ¥ν• ν’μ§ λ©λ΅ λ°ν™
   - μ μ‘ν• λΉ„νΈλ μ΄νΈλ¥Ό μ„ν• bandwidth μ •λ³΄

2. **ν’μ§λ³„ ν”λ μ΄λ¦¬μ¤νΈ** (`/api/hls/uuid123/720p`):
   - ν•΄λ‹Ή ν’μ§μ μ„Έκ·Έλ¨ΌνΈ λ©λ΅
   - μ•”νΈν™” ν‚¤ URL ν¬ν•¨

3. **μ„Έκ·Έλ¨ΌνΈ μ κ³µ** (`/api/segment/uuid123/segment_001.ts`):
   - XOR λ³µνΈν™” μν–‰
   - AES-128 μ•”νΈν™” μƒνƒλ΅ λ°ν™
   - Range μ”μ²­ μ§€μ›

4. **ν‚¤ μ κ³µ** (`/api/key/uuid123`):
   - μΈμ¦λ μ‚¬μ©μμ—κ²λ§ HLS λ³µνΈν™” ν‚¤ μ κ³µ
   - ν† ν° κΈ°λ° μ ‘κ·Ό μ μ–΄

### 3λ‹¨κ³„: νμΌ κ°μ‹ λ° μλ™ λ³€ν™
**λ©ν‘**: μ¤€λΉ„ ν΄λ” κ°μ‹ β†’ μλ™ HLS λ³€ν™ β†’ λΌμ΄λΈλ¬λ¦¬ μ΄λ™

#### κµ¬ν„ λ‚΄μ©
- `app/services/file-watcher.server.ts` ν™•μ¥
- μƒ νμΌ κ°μ§€ μ‹ HLS λ³€ν™ μλ™ μ‹¤ν–‰
- λ³€ν™ μ™„λ£ ν›„ pending.jsonμ—μ„ videos.jsonμΌλ΅ μ΄λ™
- μ›λ³Έ νμΌ μ‚­μ  μµμ…

### 4λ‹¨κ³„: ν”„λ΅ νΈμ—”λ“ HLS ν”λ μ΄μ–΄ ν†µν•©
**λ©ν‘**: κΈ°μ΅΄ VideoPlayerλ¥Ό HLS μ§€μ›μΌλ΅ μ—…κ·Έλ μ΄λ“

#### ν•„μ” μμ΅΄μ„±
```bash
bun add hls.js @types/hls.js
```

#### VideoPlayer μ»΄ν¬λ„νΈ μμ •
```typescript
// VideoPlayer.tsx μ—…κ·Έλ μ΄λ“
export function VideoPlayer({ video }: VideoPlayerProps) {
  // HLS λΉ„λ””μ¤ κ°μ§€
  const isHLSVideo = video.videoUrl.endsWith('.m3u8');
  
  if (isHLSVideo) {
    // hls.js μ‚¬μ©ν• HLS μ¬μƒ
    // μ»¤μ¤ν…€ μΈμ¦ ν—¤λ” μ¶”κ°€
    // μ μ‘ν• ν’μ§ μ΅°μ  UI
  } else {
    // κΈ°μ΅΄ λ°©μ‹ (Range μ”μ²­) μ μ§€
  }
}
```

## π”’ λ³΄μ• κµ¬ν„ μ„Έλ¶€μ‚¬ν•­

### μ΄μ¤‘ μ•”νΈν™” ν”„λ΅μ„Έμ¤

#### λ³€ν™ μ‹ μ•”νΈν™”
1. **HLS ν‘μ¤€ μ•”νΈν™”**: FFmpeg `-hls_key_info_file` μµμ…
2. **XOR μ¶”κ°€ μ•”νΈν™”**: μƒμ„±λ .ts νμΌλ“¤μ„ μ¶”κ°€ μ•”νΈν™”

#### μ¬μƒ μ‹ λ³µνΈν™”
1. **μ„λ²„μΈ΅ XOR λ³µνΈν™”**: μ„Έκ·Έλ¨ΌνΈ μ”μ²­ μ‹ μ‹¤μ‹κ°„ μ²λ¦¬
2. **ν΄λΌμ΄μ–ΈνΈμΈ΅ AES-128 λ³µνΈν™”**: hls.jsκ°€ μλ™ μ²λ¦¬

### μ ‘κ·Ό μ μ–΄
- JWT ν† ν° κΈ°λ° μ„Έκ·Έλ¨ΌνΈ μΈμ¦
- IP κΈ°λ° μ ‘κ·Ό μ ν• (μ„ νƒμ‚¬ν•­)
- μ‹κ°„ μ ν• URL (ν‚¤/μ„Έκ·Έλ¨ΌνΈ)

## π“ μ„±λ¥ μµμ ν™”

### μ„Έκ·Έλ¨ΌνΈ μ„¤μ •
- **μ„Έκ·Έλ¨ΌνΈ κΈΈμ΄**: 2μ΄ (λΉ λ¥Έ μ‹ν¬ + μ λ‹Ήν• μ¤λ²„ν—¤λ“)
- **ν‚¤ν”„λ μ„ κ°„κ²©**: 2μ΄ (μ„Έκ·Έλ¨ΌνΈ μ‹μ‘ = ν‚¤ν”„λ μ„)
- **ν’μ§ λ λ²¨**: 720p, 1080p (ν•„μ”μ‹ ν™•μ¥)

### μΊμ‹± μ „λµ
- **λΈλΌμ°μ € μΊμ‹±**: μ„Έκ·Έλ¨ΌνΈμ— μ μ ν• Cache-Control ν—¤λ”
- **μ„λ²„ μΊμ‹±**: μμ£Ό μ”μ²­λλ” μ„Έκ·Έλ¨ΌνΈ λ©”λ¨λ¦¬ μΊμ‹±
- **CDN νΈν™**: ν–¥ν›„ CDN λ„μ… μ‹ νΈν™ κ°€λ¥ν• κµ¬μ΅°

## π§ ν…μ¤νΈ κ³„ν

### κΈ°λ¥ ν…μ¤νΈ
1. **λ³€ν™ ν…μ¤νΈ**: λ‹¤μ–‘ν• ν¬λ§· β†’ HLS λ³€ν™ μ„±κ³µλ¥ 
2. **μ•”νΈν™” ν…μ¤νΈ**: μ΄μ¤‘ μ•”νΈν™”/λ³µνΈν™” μ •ν™•μ„±
3. **μ¤νΈλ¦¬λ° ν…μ¤νΈ**: λ‹¤μ–‘ν• λ„¤νΈμ›ν¬ ν™κ²½μ—μ„ μ¬μƒ
4. **μ‹ν¬ ν…μ¤νΈ**: λΉ λ¥Έ μ‹ν¬ μ„±λ¥ μΈ΅μ •

### μ„±λ¥ ν…μ¤νΈ
- **λ™μ‹ μ ‘μ†**: μ—¬λ¬ μ‚¬μ©μ λ™μ‹ μ¤νΈλ¦¬λ°
- **λ€μ©λ‰ νμΌ**: 2μ‹κ°„+ μν™” νμΌ μ²λ¦¬
- **λ©”λ¨λ¦¬ μ‚¬μ©λ‰**: λ³€ν™ λ° μ¤νΈλ¦¬λ° μ‹ λ©”λ¨λ¦¬ λ¨λ‹ν„°λ§

## π€ λ°°ν¬ κ³ λ ¤μ‚¬ν•­

### μ‹μ¤ν… μ”κµ¬μ‚¬ν•­
- **FFmpeg**: μ„λ²„μ— FFmpeg λ°”μ΄λ„λ¦¬ μ„¤μΉ ν•„μ
- **λ””μ¤ν¬ κ³µκ°„**: HLS λ³€ν™μΌλ΅ μ•½ 10-20% μ©λ‰ μ¦κ°€
- **CPU**: λ³€ν™ μ‹ CPU μ§‘μ•½μ  μ‘μ—…

### Docker λ°°ν¬
```dockerfile
# Dockerfileμ— FFmpeg μ„¤μΉ μ¶”κ°€
RUN apt-get update && apt-get install -y ffmpeg
```

## π“… κµ¬ν„ μΌμ • (μμƒ)

### Week 1: κΈ°λ° κµ¬μ΅°
- [ ] FFmpeg ν†µν•© λ° κΈ°λ³Έ HLS λ³€ν™
- [ ] μ΄μ¤‘ μ•”νΈν™” μ‹μ¤ν… κµ¬ν„
- [ ] API λΌμ°νΈ κΈ°λ³Έ κµ¬μ΅°

### Week 2: μ¤νΈλ¦¬λ° κµ¬ν„  
- [ ] HLS API μ—”λ“ν¬μΈνΈ μ™„μ„±
- [ ] ν”„λ΅ νΈμ—”λ“ hls.js ν†µν•©
- [ ] κΈ°λ³Έ μ¤νΈλ¦¬λ° λ™μ‘ ν™•μΈ

### Week 3: μµμ ν™” λ° ν…μ¤νΈ
- [ ] μ„±λ¥ μµμ ν™” (μΊμ‹±, μ••μ¶•)
- [ ] λ³΄μ• κ°•ν™” (ν† ν° μΈμ¦)
- [ ] λ‹¤μ–‘ν• μ‹λ‚λ¦¬μ¤ ν…μ¤νΈ

### Week 4: ν†µν•© λ° λ°°ν¬
- [ ] κΈ°μ΅΄ μ‹μ¤ν…κ³Ό ν†µν•©
- [ ] λ°°ν¬ ν™κ²½ μ„¤μ •
- [ ] λ¬Έμ„ν™” λ° μ‚¬μ©μ κ°€μ΄λ“

## π”„ λ§μ΄κ·Έλ μ΄μ… μ „λµ

### κΈ°μ΅΄ μ‹μ¤ν…κ³Ό νΈν™μ„±
- **κΈ°μ΅΄ MP4**: Range μ”μ²­ λ°©μ‹ μ μ§€ (ν•μ„ νΈν™)
- **μƒ μ—…λ΅λ“**: HLS λ°©μ‹μΌλ΅ μλ™ λ³€ν™
- **μ μ§„μ  λ§μ΄κ·Έλ μ΄μ…**: κΈ°μ΅΄ νμΌλ“¤λ„ μ„ νƒμ  HLS λ³€ν™

### λ΅¤λ°± κ³„ν
- κΈ°μ΅΄ Range μ”μ²­ λ°©μ‹μ€ κ·Έλ€λ΅ μ μ§€
- HLS λ¬Έμ  λ°μƒ μ‹ κΈ°μ΅΄ λ°©μ‹μΌλ΅ fallback
- μ„¤μ •μ„ ν†µν• HLS μ‚¬μ© μ—¬λ¶€ μ μ–΄

---

**π“ μ°Έκ³ μ‚¬ν•­**: μ΄ κ³„νμ€ PRDμ λ¨λ“  μ”κµ¬μ‚¬ν•­μ„ λ§μ΅±ν•λ©΄μ„λ„ Netflix/YouTube μμ¤€μ μ¤νΈλ¦¬λ° μ„±λ¥μ„ ν™•λ³΄ν•λ” κ²ƒμ„ λ©ν‘λ΅ ν•©λ‹λ‹¤. κµ¬ν„ κ³Όμ •μ—μ„ μ„Έλ¶€μ‚¬ν•­μ€ μ΅°μ •λ  μ μμµλ‹λ‹¤.